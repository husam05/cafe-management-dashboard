// schema.prisma - Complete Cafe Financial Management System
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  QR
  OTHER
}

enum ShiftStatus {
  OPEN
  CLOSED
}

enum SaleStatus {
  PAID
  VOID
  REFUND
}

enum PayrollStatus {
  OPEN
  CLOSED
}

enum PayrollItemType {
  SALARY
  ADVANCE
  BONUS
  DEDUCTION
  OVERTIME
}

enum MovementType {
  IN
  OUT
  WASTE
  ADJUST
}

// ==========================================
// MASTER DATA
// ==========================================

model Category {
  id          BigInt   @id @default(autoincrement())
  name        String   @db.VarChar(120)
  description String?  @db.Text
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  products    Product[]
  @@index([sortOrder])
  @@map("categories")
}

model Product {
  id          BigInt   @id @default(autoincrement())
  categoryId  BigInt
  name        String   @db.VarChar(200)
  description String?  @db.Text
  imageUrl    String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category    Category @relation(fields: [categoryId], references: [id])
  variants    ProductVariant[]
  saleItems   SaleItem[]
  recipes     Recipe[]
  
  @@index([categoryId])
  @@map("products")
}

model ProductVariant {
  id          BigInt  @id @default(autoincrement())
  productId   BigInt
  variantName String  @db.VarChar(80)
  price       Decimal @db.Decimal(12,2)
  costEst     Decimal? @db.Decimal(12,2)
  sku         String? @db.VarChar(80)
  isActive    Boolean @default(true)

  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems   SaleItem[]
  recipes     Recipe[]

  @@index([productId])
  @@map("product_variants")
}

// ==========================================
// PEOPLE
// ==========================================

model Employee {
  id         BigInt   @id @default(autoincrement())
  fullName   String   @db.VarChar(160)
  role       String?  @db.VarChar(80)
  phone      String?  @db.VarChar(40)
  email      String?  @db.VarChar(120)
  baseSalary Decimal? @db.Decimal(12,2)
  isActive   Boolean  @default(true)
  hiredAt    DateTime?
  createdAt  DateTime @default(now())

  shiftsOpened Shift[] @relation("ShiftOpenedBy")
  shiftsClosed Shift[] @relation("ShiftClosedBy")
  expensesPaid Expense[]
  payrollItems PayrollItem[]

  @@index([isActive])
  @@map("employees")
}

model Customer {
  id      BigInt  @id @default(autoincrement())
  name    String? @db.VarChar(160)
  phone   String? @db.VarChar(40)
  email   String? @db.VarChar(120)
  
  sales   Sale[]
  @@map("customers")
}

// ==========================================
// SALES & SHIFTS
// ==========================================

model Shift {
  id           BigInt      @id @default(autoincrement())
  businessDate DateTime    @db.Date
  shiftNo      Int
  openingCash  Decimal     @default(0) @db.Decimal(12,2)
  closingCash  Decimal?    @db.Decimal(12,2)
  openedAt     DateTime    @default(now())
  closedAt     DateTime?
  status       ShiftStatus @default(OPEN)
  note         String?     @db.Text

  openedById   BigInt?
  closedById   BigInt?

  openedBy     Employee? @relation("ShiftOpenedBy", fields: [openedById], references: [id])
  closedBy     Employee? @relation("ShiftClosedBy", fields: [closedById], references: [id])

  sales        Sale[]

  @@unique([businessDate, shiftNo])
  @@index([businessDate])
  @@map("shifts")
}

model Sale {
  id           BigInt     @id @default(autoincrement())
  invoiceNo    String     @unique @db.VarChar(40)
  businessDate DateTime   @db.Date
  shiftId      BigInt?
  customerId   BigInt?
  tableNumber  String?    @db.VarChar(20)
  orderType    String?    @db.VarChar(40)

  subtotal     Decimal    @default(0) @db.Decimal(12,2)
  discount     Decimal    @default(0) @db.Decimal(12,2)
  tax          Decimal    @default(0) @db.Decimal(12,2)
  total        Decimal    @default(0) @db.Decimal(12,2)
  status       SaleStatus @default(PAID)
  createdAt    DateTime   @default(now())

  shift        Shift?     @relation(fields: [shiftId], references: [id])
  customer     Customer?  @relation(fields: [customerId], references: [id])

  items        SaleItem[]
  payments     Payment[]

  @@index([businessDate])
  @@index([shiftId])
  @@map("sales")
}

model SaleItem {
  id        BigInt  @id @default(autoincrement())
  saleId    BigInt
  productId BigInt
  variantId BigInt?

  qty       Decimal @default(1) @db.Decimal(12,3)
  unitPrice Decimal @db.Decimal(12,2)
  lineTotal Decimal @db.Decimal(12,2)

  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

model Payment {
  id       BigInt        @id @default(autoincrement())
  saleId   BigInt
  method   PaymentMethod
  amount   Decimal       @db.Decimal(12,2)
  paidAt   DateTime      @default(now())
  refNo    String?       @db.VarChar(120)

  sale     Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([paidAt])
  @@map("payments")
}

// ==========================================
// EXPENSES
// ==========================================

model Vendor {
  id    BigInt  @id @default(autoincrement())
  name  String  @db.VarChar(200)
  phone String? @db.VarChar(40)
  note  String? @db.Text

  expenses Expense[]
  @@map("vendors")
}

model ExpenseCategory {
  id   BigInt @id @default(autoincrement())
  name String @unique @db.VarChar(120)
  icon String? @db.VarChar(50)
  color String? @db.VarChar(20)

  expenses Expense[]
  @@map("expense_categories")
}

model Expense {
  id            BigInt        @id @default(autoincrement())
  expenseDate   DateTime      @db.Date
  categoryId    BigInt
  vendorId      BigInt?
  amount        Decimal       @db.Decimal(12,2)
  description   String?       @db.Text
  paidById      BigInt?
  paymentMethod PaymentMethod?
  receiptUrl    String?       @db.Text
  createdAt     DateTime      @default(now())

  category      ExpenseCategory @relation(fields: [categoryId], references: [id])
  vendor        Vendor?         @relation(fields: [vendorId], references: [id])
  paidBy        Employee?       @relation(fields: [paidById], references: [id])

  @@index([expenseDate])
  @@index([categoryId])
  @@index([vendorId])
  @@map("expenses")
}

// ==========================================
// PAYROLL
// ==========================================

model PayrollRun {
  id        BigInt        @id @default(autoincrement())
  payMonth  DateTime      @db.Date
  status    PayrollStatus @default(OPEN)
  note      String?       @db.Text
  createdAt DateTime      @default(now())
  closedAt  DateTime?

  items     PayrollItem[]

  @@unique([payMonth])
  @@map("payroll_runs")
}

model PayrollItem {
  id           BigInt          @id @default(autoincrement())
  payrollId    BigInt
  employeeId   BigInt
  itemType     PayrollItemType
  amount       Decimal         @db.Decimal(12,2)
  note         String?         @db.Text
  paidAt       DateTime?
  paymentMethod PaymentMethod?

  payroll      PayrollRun  @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  employee     Employee    @relation(fields: [employeeId], references: [id])

  @@index([payrollId])
  @@index([employeeId])
  @@index([paidAt])
  @@map("payroll_items")
}

// ==========================================
// INVENTORY & RECIPES
// ==========================================

model InventoryItem {
  id           BigInt   @id @default(autoincrement())
  name         String   @db.VarChar(200)
  unit         String   @db.VarChar(30)
  currentStock Decimal  @default(0) @db.Decimal(12,3)
  reorderLevel Decimal? @db.Decimal(12,3)
  costPerUnit  Decimal? @db.Decimal(12,2)
  isActive     Boolean  @default(true)

  movements    InventoryMovement[]
  recipes      Recipe[]
  @@map("inventory_items")
}

model InventoryMovement {
  id           BigInt       @id @default(autoincrement())
  itemId       BigInt
  movementType MovementType
  qty          Decimal      @db.Decimal(12,3)
  unitCost     Decimal?     @db.Decimal(12,2)
  movementAt   DateTime     @default(now())
  refType      String?      @db.VarChar(30)
  refId        BigInt?
  note         String?      @db.Text

  item         InventoryItem @relation(fields: [itemId], references: [id])

  @@index([itemId])
  @@index([movementAt])
  @@index([movementType])
  @@map("inventory_movements")
}

model Recipe {
  id        BigInt  @id @default(autoincrement())
  productId BigInt
  variantId BigInt?
  itemId    BigInt
  qtyNeeded Decimal @db.Decimal(12,3)

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  item      InventoryItem @relation(fields: [itemId], references: [id])

  @@unique([productId, variantId, itemId])
  @@index([itemId])
  @@map("recipes")
}

// ==========================================
// DAILY SUMMARY (for quick KPIs)
// ==========================================

model DailySummary {
  id            BigInt   @id @default(autoincrement())
  businessDate  DateTime @unique @db.Date
  totalRevenue  Decimal  @default(0) @db.Decimal(14,2)
  totalExpenses Decimal  @default(0) @db.Decimal(14,2)
  totalPayroll  Decimal  @default(0) @db.Decimal(14,2)
  totalCOGS     Decimal  @default(0) @db.Decimal(14,2)
  netProfit     Decimal  @default(0) @db.Decimal(14,2)
  orderCount    Int      @default(0)
  avgTicket     Decimal  @default(0) @db.Decimal(12,2)
  updatedAt     DateTime @updatedAt

  @@index([businessDate])
  @@map("daily_summaries")
}
